<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PURPLE: FINAL PERFECTION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial', sans-serif; }
        #ui-layer { 
            position: absolute; top: 0; width: 100%; height: 100%; 
            pointer-events: none; display: flex; flex-direction: column; 
            justify-content: space-between; align-items: center; padding: 20px;
        }
        .status-text { color: #fff; font-size: 20px; letter-spacing: 5px; text-shadow: 0 0 10px #8a2be2; }
        #record-btn { 
            pointer-events: auto; padding: 15px 30px; border: 2px solid #8a2be2; 
            background: rgba(0,0,0,0.5); color: white; cursor: pointer; border-radius: 50px;
            font-weight: bold; transition: 0.3s; margin-bottom: 40px;
        }
        #record-btn:hover { background: #8a2be2; box-shadow: 0 0 20px #8a2be2; }
    </style>
</head>
<body>
    <div id="ui-layer">
        <div id="msg" class="status-text">SYNCING WITH THE INFINITY...</div>
        <button id="record-btn" onclick="toggleRecording()">START RECORDING</button>
    </div>

    <script>
        let handpose, video, predictions = [];
        let purpleScale = 0;
        let recorder, chunks = [];
        let isRecording = false;

        function setup() {
            let canvas = createCanvas(windowWidth, windowHeight);
            video = createCapture(VIDEO);
            video.size(640, 480);
            video.hide();

            // Setup Recording
            let stream = canvas.elt.captureStream(30);
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = saveVideo;

            handpose = ml5.handpose(video, () => {
                document.getElementById('msg').innerHTML = "TECHNIQUE: ACTIVATED";
            });
            handpose.on("predict", results => predictions = results);
        }

        function draw() {
            background(0);
            
            // Mirror Camera with High Contrast
            push();
            translate(width, 0);
            scale(-1, 1);
            tint(200, 210, 255, 120); 
            image(video, 0, 0, width, height);
            pop();

            if (predictions.length > 0) {
                let h1 = predictions[0].landmarks[8];
                let x1 = map(h1[0], 0, 640, width, 0);
                let y1 = map(h1[1], 0, 480, 0, height);

                if (predictions.length >= 2) {
                    let h2 = predictions[1].landmarks[8];
                    let x2 = map(h2[0], 0, 640, width, 0);
                    let y2 = map(h2[1], 0, 480, 0, height);
                    let d = dist(x1, y1, x2, y2);

                    if (d > 120) {
                        purpleScale = lerp(purpleScale, 0, 0.3);
                        drawEnergyOrb(x1, y1, 80, [255, 10, 50], "RED");
                        drawEnergyOrb(x2, y2, 80, [10, 100, 255], "BLUE");
                    } else {
                        // THE FINAL MERGE
                        purpleScale = lerp(purpleScale, 350, 0.15);
                        let midX = (x1 + x2) / 2;
                        let midY = (y1 + y2) / 2;
                        drawHollowPurple(midX, midY, purpleScale);
                        if(purpleScale > 300) screenShake();
                    }
                } else {
                    drawEnergyOrb(x1, y1, 50, [255, 255, 255], "CURSED ENERGY");
                }
            }
        }

        function drawEnergyOrb(x, y, sz, rgb, label) {
            for(let i=0; i<5; i++) {
                fill(rgb[0], rgb[1], rgb[2], 40);
                noStroke();
                ellipse(x + random(-5,5), y + random(-5,5), sz + i*10);
            }
            fill(255);
            textAlign(CENTER);
            text(label, x, y - sz);
        }

        function drawHollowPurple(x, y, sz) {
            // Purple core
            fill(0);
            stroke(255);
            strokeWeight(2);
            ellipse(x, y, sz * 0.4);
            
            // Aura rings
            noFill();
            for(let i=0; i<12; i++) {
                stroke(138, 43, 226, 200 - i*15);
                strokeWeight(random(2, 10));
                ellipse(x, y, sz + random(-10, 10));
            }

            // Space-time distortion lines
            stroke(255, 255, 255, 150);
            for(let i=0; i<20; i++) {
                let a = random(TWO_PI);
                let r = random(sz, sz*2);
                line(x, y, x + cos(a)*r, y + sin(a)*r);
            }
        }

        function screenShake() {
            translate(random(-10, 10), random(-10, 10));
        }

        function toggleRecording() {
            isRecording = !isRecording;
            let btn = document.getElementById('record-btn');
            if (isRecording) {
                chunks = [];
                recorder.start();
                btn.innerHTML = "STOP & SAVE CLIP";
                btn.style.borderColor = "red";
            } else {
                recorder.stop();
                btn.innerHTML = "START RECORDING";
                btn.style.borderColor = "#8a2be2";
            }
        }

        function saveVideo() {
            let blob = new Blob(chunks, { type: 'video/webm' });
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = 'hollow_purple_aura.webm';
            a.click();
        }

        function windowResized() { resizeCanvas(windowWidth, windowHeight); }
    </script>
</body>
</html>
